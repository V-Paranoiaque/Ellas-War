<app-common-top-bar active="messages"></app-common-top-bar>

<div class="modal fade" id="MsgNew" tabindex="-1" aria-hidden="true">
  <app-messages-popup></app-messages-popup>
</div>

<div class="modal fade" id="MsgSetRead" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" translate>Set all messages as read</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" 
                aria-label="Close"></button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" 
                data-bs-dismiss="modal" translate>Close</button>
        <button type="button" class="btn btn-primary"
                (click)="setAllRead()"
                data-bs-dismiss="modal" translate>Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="DeleteMultipleMsg" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" translate>
          Delete all the selected messages
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" 
                aria-label="Close"></button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" 
                data-bs-dismiss="modal" translate>Close</button>
        <button type="button" class="btn btn-primary" 
                data-bs-dismiss="modal" (click)="messageDeleteMultiple()"
                translate>Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="DeleteMsg" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" translate>
          Delete the selected messages
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" 
                aria-label="Close"></button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" 
                data-bs-dismiss="modal" translate>Close</button>
        <button type="button" class="btn btn-primary" 
                data-bs-dismiss="modal" (click)="messageDelete()"
                translate>Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="home-bg home-bg-private">
  <div class="col-lg-10 col-md-10 col-sm-12 col-12 main">
    <div class="container">
      <div class="row">
        <div class="col-xl-6 col-block-half">
          <div class="alert alert-success d-lg-none" *ngIf="msgSent > 0" translate>
            Message sent
          </div>
          <div class="card">
            <div class="card-flex text-center">
              <button class="btn btn-primary d-lg-none"
                      (click)="messageLoad(0)"
                      data-bs-toggle="modal" data-bs-target="#MsgNew"
                      title="{{'Write a new message'| translate}}">
                <app-ic-icon [icon]="brushIcon"></app-ic-icon>
              </button>
              <button class="btn btn-primary d-none d-lg-block"
                      (click)="messageLoad(0)"
                      title="{{'Write a new message'| translate}}">
                <app-ic-icon [icon]="brushIcon"></app-ic-icon>
              </button>
              <button class="btn btn-info" data-bs-toggle="modal"
                      title="{{'Set all messages as read'| translate}}"
                      data-bs-target="#MsgSetRead">
                <app-ic-icon [icon]="envelopeFill"></app-ic-icon>
              </button>
              <button class="btn btn-warning" (click)="switchDeleteMode()"
                      title="{{'Switch to delete mode'| translate}}">
                <app-ic-icon [icon]="trashIcon"></app-ic-icon>
              </button>
              <button [ngClass]="{'d-none': getDeleteMode() === 0}"
                      title="{{'Delete all the selected messages'| translate}}"
                      class="btn btn-danger" data-bs-toggle="modal" 
                      data-bs-target="#DeleteMultipleMsg">
                  <app-ic-icon [icon]="trash2Icon"></app-ic-icon>
                </button>
            </div>
            <div class="card-body"
                [ngClass]="{'no-bottom': getMsgPageNb() > 1}">
              <div class="text-center mt-2 mb-2" *ngIf="getMsgList().length === 0" translate>
                Your message box is empty
              </div>
              <select class="form-select mb-2" *ngIf="categoryList.length > 1"
                      (change)="setPage(1)" [(ngModel)]="currentCategory">
                <option value="0" translate>All the messages</option>
                <option value="2" *ngIf="categoryList.includes(2)" translate>Private messages</option>
                <option value="3" *ngIf="categoryList.includes(3)" translate>Alliance</option>
                <option value="4" *ngIf="categoryList.includes(4)" translate>Attacks</option>
                <option value="1" *ngIf="categoryList.includes(1)" translate>Spying</option>
                <option value="5" *ngIf="categoryList.includes(5)" translate>Weather incidents</option>
                <option value="6" *ngIf="categoryList.includes(6)" translate>Agora</option>
                <option value="7" *ngIf="categoryList.includes(7)" translate>Sanctuaries</option>
                <option value="8" *ngIf="categoryList.includes(8)" translate>Game messages</option>
                <option value="9" *ngIf="categoryList.includes(9)" translate>Others</option>
              </select>
              <div *ngFor="let msg of getMsgList()" class="d-flex bd-highlight"
                  [ngClass]="{'selected': msg.msg_id === getCurrentMsg().id, 'new': msg.msg_read === 0}"
                  role="button" (click)="messageLoad(msg)">
                <div class="p-2 bd-highlight border-top d-flex" *ngIf="getDeleteMode() === 1">
                  <input type="checkbox" [checked]="msg.isChecked" 
                        [(ngModel)]="msg.isChecked" />
                </div>
                <div class="p-2 flex-grow-1 bd-highlight border-top">
                  <app-messages-title [msg]="msg"></app-messages-title>
                  <div class="fw-lighter">
                    {{ msg.last_date | date:'dd/MM/yyyy, HH:mm' }}
                  </div>
                </div>
                <div class="p-2 bd-highlight border-top">
                  <div *ngFor="let u of msg.mb_list">
                    <a [routerLink]="['/profile', u.id]" *ngIf="msg.msg_type === 0">{{u.username}}</a>
                    <i *ngIf="msg.msg_type > 0">{{u.username}}</i>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="input-group" *ngIf="getMsgPageNb() > 1">
            <span class="input-group-text" role="button" (click)="setPage(1)">&lt;&lt;</span>
            <span class="input-group-text" role="button" (click)="setPage(currentPage, -1)">&lt;</span>
            <select class="form-select" (change)="pageLoad($event)" [(ngModel)]="currentPage">
              <option *ngFor="let item of [].constructor(getMsgPageNb()); let i = index"
                      value="{{ i +1 }}" translate>Page {{ i +1 }}</option>
            </select>
            <span class="input-group-text" role="button" (click)="setPage(currentPage, 1)">&gt;</span>
            <span class="input-group-text" role="button" (click)="setPage(getMsgPageNb())">&gt;&gt;</span>
          </div>
        </div>
        
        <div class="col-xl-6 col-block-half text-center" *ngIf="getCurrentMsg().id > 0">
          <div class="card card-normal card-msg" id="msgBlock">
            <div class="card-body">
              <h2>
                <app-messages-title [msg]="getCurrentMsg()"></app-messages-title>
                &nbsp;
                <button class="btn btn-warning" (click)="shareMsg()">
                  <app-ic-icon [icon]="share"></app-ic-icon>
                </button>
                &nbsp;
                <button class="btn btn-danger" data-bs-toggle="modal"
                        data-bs-target="#DeleteMsg">
                  <app-ic-icon [icon]="trashIcon"></app-ic-icon>
                </button>
              </h2>
            </div>
            <div *ngIf="getCurrentMsg().msg_shared === 1" class="card-body text-center">
              <div class="wg-bold text-danger"
                  *ngIf="linkSaved === 1"
                  translate>Link saved to clipboard</div>
              <strong translate>Share link:</strong>
              {{ getCurrentMsg().url }}/permalink/{{ getCurrentMsg().id }}
              <span class="badge bg-primary" role="button" (click)="copyLink()"
                    [cbContent]="getCurrentMsg().url+'/permalink/'+getCurrentMsg().id"
                    ngxClipboard>
                <app-ic-icon [icon]="clipboardCheck" ></app-ic-icon>
              </span>
            </div>
            
            <div class="card-body" *ngIf="getCurrentMsg().msg_type === 0">
              <div class="input-group">
                <textarea class="form-control" placeholder="{{'Message'|translate}}"
                          [(ngModel)]="answerText"></textarea>
                <span class="input-group-addon btn btn-primary"
                      (click)="answer()" translate>Send</span>
              </div>
            </div>
            <div *ngFor="let msg of getCurrentMsg().msg" class="card-body">
              <app-messages-content [msg]="msg" [full]="getCurrentMsg()"></app-messages-content>
            </div>
          </div>
        </div>
        
        <div class="col-xl-6 col-block-half text-center d-none d-lg-flex flex-grow-1"
             *ngIf="getCurrentMsg().id === 0">
          <div class="card card-normal d-flex flex-grow-1">
            <div class="card-body d-flex flex-column">
              <div class="alert alert-success" *ngIf="msgSent > 0" translate>
                Message sent
              </div>

              <div class="mb-2" *ngIf="getDestList().length > 0">

                <span class="badge bg-primary" *ngFor="let user of getDestList()">
                  {{ user.username }}
                  <app-ic-icon [icon]="xIcon" role="button" (click)="removeDest(user.id)"></app-ic-icon>
                </span>
              </div>
              
              <div class="input-group mb-2">
                <span class="input-group-text" translate>To: </span>
                <input type="text" class="form-control" aria-label="Player" 
                      placeholder="{{'Player'|translate}}" [(ngModel)]="msgToUser"
                      (keydown.enter)="addDestGUi(msgToUser)" >
                <span class="input-group-text text-center" role="button" 
                      (click)="addDestGUi(msgToUser)">
                  <app-ic-icon [icon]="plusIcon"></app-ic-icon>
                </span>
              </div>
              <div *ngIf="addDestError > 0" class="alert alert-danger"
                  translate>This player doesn't exist</div>
              <div *ngIf="addDestError === 0 && noDestError > 0" class="alert alert-danger"
                  translate>You must add a recipient</div>
              <div *ngIf="textError === 1" class="alert alert-danger"
                  translate>Your message or its title is empty</div>
              <input type="text" class="form-control" 
                    placeholder="{{'Title'|translate}}" [(ngModel)]="msgTitle" />
              
              <div class="input-group d-flex flex-grow-1 mt-2">
                <textarea class="form-control" placeholder="{{'Message'|translate}}"
                          [(ngModel)]="msgText"></textarea>
                <span class="input-group-addon btn btn-primary d-flex align-items-center"
                      role="button" (click)="send()">
                  <span translate>Send</span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-connected-right-menu></app-connected-right-menu>
</div>

<app-common-bottom-bar></app-common-bottom-bar>
