<app-common-top-bar active="storeroom"></app-common-top-bar>

<div class="modal fade" id="StoreroomHistory" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <app-storeroom-history-popup></app-storeroom-history-popup>
  </div>
</div>

<div class="home-bg home-bg-private">
  <div class="col-lg-10 col-md-10 col-sm-12 col-12 main main-top" role="main">
    <div class="container">
      <div class="row">
        <div class="col-md-6 col-12 col-block-half d-flex">
          <div class="card col-12">
            <div class="card-header" translate>
              Drop resources to the Agora
            </div>
            <div class="card-body text-center">
              <span *ngIf="storeroomMin.rate > 0">
                <span translate>Current rate</span>
                <span translate>:</span> {{ storeroomMin.rate| number:'': this.translate.currentLang}}
                <app-id-to-ress [ress_id]="'drachma'"></app-id-to-ress>
                <span *ngIf="storeroomMin.you > 0">-</span>
              </span>
              
              <span *ngIf="storeroomMin.you > 0">
                <span translate>You</span><span translate>:</span> {{ storeroomMin.you| number:'': this.translate.currentLang}}
                <app-id-to-ress [ress_id]="'drachma'"></app-id-to-ress>
              </span>
              
              <div class="input-group d-flex flex-row">
                <div class="d-flex flex-column">
                  <span class="input-group-text mt-2"
                        id="aria-quantity" translate>Quantity</span>
                        
                  <span class="input-group-text mt-2"
                        id="aria-rate" translate>Rate</span>
                </div>
                <div class="d-flex flex-column flex-grow-1">
                  <input type="number" placeholder="0" step="1" [attr.min]="0"
                        class="form-control mt-2" aria-describedby="aria-quantity"
                        [attr.aria-label]="['Quantity'|translate]"
                        [(ngModel)]="storeroomQuantity">
                  <input type="number" placeholder="0" step="0.001" [attr.min]="0"
                        class="form-control mt-2" aria-describedby="aria-rate"
                        [attr.aria-label]="['Rate'|translate]"
                        [(ngModel)]="storeroomRate">
                </div>
              </div>
              
              <select class="form-select text-center mt-2"
                      [(ngModel)]="storeroomRess" (change)="setRess()"
                      [attr.aria-label]="['Select the resource'|translate]">
                <option value="1" translate>Food</option>
                <option value="2" translate>Water</option>
                <option value="3" translate>Wood</option>
                <option value="4" translate>Iron</option>
                <option *ngIf="user.getLevel() >= user.getLevelRess('stone')"
                        value="5" translate>Stone</option>
                <option *ngIf="user.getLevel() >= user.getLevelRess('marble')"
                        value="6" translate>Marble</option>
                <option *ngIf="user.getLevel() >= user.getLevelRess('grapes')"
                        value="7" translate>Grapes</option>
                <option *ngIf="user.getLevel() >= user.getLevelRess('wine')"
                        value="8" translate>Wine</option>
                <option *ngIf="user.getLevel() >= user.getLevelRess('gold')"
                        value="9" translate>Gold</option>
                <option value="10" translate>Favor</option>
              </select>
              <br />
              <button class="btn btn-success" (click)="storeroomSell()"
                      translate>Depose</button>
              <br />
              <br />
              <div translate>The lots remain on the market during 7 days</div>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-12 col-block-half d-flex">
          <div class="card col-12">
            <div id="BuyResourcesDesc" class="card-header" translate>
              Buy resources
            </div>
            <div class="card-body">
              <div *ngIf="getStoreroomList().length === 0"
                  class="text-center" translate>
                No resource available on the Agora
              </div>
              <table class="table table-middle" aria-describedby="BuyResourcesDesc"
                    *ngIf="getStoreroomList().length > 0">
                <thead>
                  <tr>
                    <th scope="col"></th>
                    <th scope="col" translate>Resources</th>
                    <th scope="col" translate>Rate</th>
                    <th scope="col" translate>Quantity</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let trade of getStoreroomList();">
                    <ng-container *ngIf="(((trade.resource_id == 1 && user.getLevel() >= user.getLevelRess('food')) ||
                                          (trade.resource_id == 2 && user.getLevel() >= user.getLevelRess('water')) ||
                                          (trade.resource_id == 3 && user.getLevel() >= user.getLevelRess('wood')) ||
                                          (trade.resource_id == 4 && user.getLevel() >= user.getLevelRess('iron')) ||
                                          (trade.resource_id == 5 && user.getLevel() >= user.getLevelRess('stone')) ||
                                          (trade.resource_id == 6 && user.getLevel() >= user.getLevelRess('marble')) ||
                                          (trade.resource_id == 7 && user.getLevel() >= user.getLevelRess('grapes')) ||
                                          (trade.resource_id == 8 && user.getLevel() >= user.getLevelRess('wine')) ||
                                          (trade.resource_id == 9 && user.getLevel() >= user.getLevelRess('gold')) ||
                                          (trade.resource_id ==10 && user.getLevel() >= user.getLevelRess('favor'))) &&
                                          (trade.remaining > 0 || trade.mremaining > 0))">
                      <td>
                        <button class="btn btn-primary" *ngIf="trade.remaining > 0"
                                title="{{'Select all the resources'|translate}}"
                                (click)=selectResources(trade)>
                          <ic-icon [icon]="plusIcon"></ic-icon>
                        </button>
                      </td>
                      <td class="text-end">
                        <span *ngIf="trade.remaining > 0">{{trade.remaining | number:'': this.translate.currentLang }}</span>
                        <span *ngIf="trade.remaining == 0">{{trade.mremaining | number:'': this.translate.currentLang }}</span>
                        &nbsp;
                        <app-id-to-ress [ress_id]="trade.resource_id"></app-id-to-ress>
                      </td>
                      <td>
                        <span *ngIf="trade.remaining > 0">{{trade.rate | number:'': this.translate.currentLang }}</span>
                        <span *ngIf="trade.remaining == 0">{{trade.mrate | number:'': this.translate.currentLang }}</span>
                      </td>
                      <td>
                        <input type="number" class="form-control"
                              [(ngModel)]="storeroom_ress[trade.resource_id]"
                              [attr.min]="0" [attr.max]=trade.remaining step="1" 
                              placeholder="0" [hidden]="trade.remaining == 0" />
                      </td>
                      <td class="center">
                        <button class="btn btn-success"
                                (click)="storeroomBuy(trade.resource_id, storeroom_ress[trade.resource_id], trade.rate)"
                                title="{{'Buy'|translate}}" *ngIf="trade.remaining > 0">
                          <ic-icon [icon]="bagIcon"></ic-icon>
                          <span class="visually-hidden" translate>Buy</span>
                        </button>
                      </td>
                    </ng-container>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 col-12 col-block-half d-flex">
          <div class="card col-12">
            <div class="card-header" id="MySalesDesc">
              <span translate>
                Currently for sale
              </span>
              <div class="card-header-group">
                <div class="card-header-button" role="button"
                    data-bs-toggle="modal" data-bs-target="#StoreroomHistory"
                    (click)="storeroomHistory()">
                  <ic-icon [icIcon]="clockIcon"></ic-icon>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="fw-bold text-center">
                <span class="bold" translate>Redemption rate:</span>
                <span *ngIf="user.getPropertyNb('bonus_trade') == 0">
                  {{(80+user.getPropertyNb('hermes')*17.5)| number:'': this.translate.currentLang}}%
                </span>
                <span *ngIf="user.getPropertyNb('bonus_trade') > 0">
                  {{(80+user.getPropertyNb('hermes')*17.5)+((20-user.getPropertyNb('hermes')*17.5)/2)| number:'': this.translate.currentLang}}
                </span>
                <br/>
                <span class="bold" translate>Return rate:</span>
                <span *ngIf="user.getPropertyNb('bonus_trade') == 0">
                  {{(75+user.getPropertyNb('hermes')*17.5)| number:'': this.translate.currentLang}}%
                </span>
                <span *ngIf="user.getPropertyNb('bonus_trade') > 0">
                  {{(75+user.getPropertyNb('hermes')*17.5)+((25-user.getPropertyNb('hermes')*17.5)/2)| number:'': this.translate.currentLang}}
                </span>
              </div>
              
              <div class="text-center fw-bold"
                  *ngIf="getStoreroomMyList().length === 0">
                <br/>
                <span translate>
                  You currently don't have any batch on sales
                </span>
              </div>
              
              <table class="table table-middle" aria-describedby="MySalesDesc"
                    *ngIf="getStoreroomMyList().length > 0">
                <thead>
                  <tr>
                    <th scope="col" translate>Resources</th>
                    <th scope="col" translate>Rate</th>
                    <th scope="col" translate>Price</th>
                    <th scope="col" translate>Return</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let trade of getStoreroomMyList();let id=index;"
                    [ngClass]="{'bg-red': trade.mrate < trade.rate && trade.mrate > 0,
                                'grey': trade.mrate == trade.rate && trade.rate > 0,
                                'bg-green': (trade.mrate > 0 && trade.mrate > trade.rate) || (trade.rate > 0 && trade.mrate == 0)}">
                    <td>
                      {{trade.remaining| number:'': this.translate.currentLang}}
                      <app-id-to-ress [ress_id]=trade.resource_id></app-id-to-ress>
                    </td>
                    <td>{{trade.rate | number:'': this.translate.currentLang }}</td>
                    <td>
                      {{trade.rate*trade.remaining | number:'': this.translate.currentLang }}
                      <app-id-to-ress [ress_id]="'drachma'"></app-id-to-ress>
                    </td>
                    <td class="center">{{trade.return_time*1000| date:'dd/MM, HH:mm'}}</td>
                    <td class="center">
                      <button class="btn btn-warning"
                        (click)="storeroomRedeem(trade.storeroom_id, trade.remaining)"
                        title="{{'Recover'|translate}}">
                        <ic-icon [icon]="jarIcon"></ic-icon>
                        <span class="visually-hidden" translate>Recover</span>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-12 col-block-half d-flex">
          <div class="card col-12">
            <div class="card-header" id="titleLastWeek" translate>
              Last week
            </div>
            <div class="card-body">
              <div *ngIf="getStoreroomStatsNb() == 0"
                  class="text-center" translate>
                No statistics available about last week 
              </div>
              <table class="table table-middle" aria-describedby="titleLastWeek"
                    *ngIf="getStoreroomStatsNb() > 0">
                <thead>
                  <tr>
                    <th scope="col"></th>
                    <th scope="col" translate>Average rate</th>
                    <th scope="col" translate>Deposits</th>
                    <th scope="col" translate>Sales</th>
                    <th scope="col"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let batch of getStoreroomStats();let id=index;" class="text-end">
                    <ng-container *ngIf="id > 0 && (batch.rate > 0 || batch.quantity > 0 || batch.solded > 0)">
                      <td class="text-center"><app-id-to-ress [ress_id]="id"></app-id-to-ress></td>
                      <td>{{batch.rate | number:'': this.translate.currentLang }}</td>
                      <td>{{batch.quantity | number:'': this.translate.currentLang }}</td>
                      <td>{{batch.solded | number:'': this.translate.currentLang }}</td>
                    </ng-container>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-connected-right-menu></app-connected-right-menu>
</div>

<app-common-bottom-bar></app-common-bottom-bar>
